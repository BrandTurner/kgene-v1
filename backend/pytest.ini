[pytest]
# =============================================================================
# Pytest Configuration for KEGG Explore Backend
#
# WHAT IS PYTEST?
# Pytest is Python's most popular testing framework. It discovers and runs
# tests automatically, provides powerful fixtures for setup/teardown, and
# generates detailed failure reports.
#
# WHY THIS CONFIGURATION?
# Our backend uses async/await throughout (FastAPI, SQLAlchemy async, ARQ).
# This config ensures pytest properly handles async tests and provides
# good developer experience with clear output and coverage reports.
# =============================================================================

# === ASYNC TEST SUPPORT ===
# FastAPI, SQLAlchemy async, and ARQ all use asyncio.
# This tells pytest-asyncio to automatically handle async test functions
# without requiring @pytest.mark.asyncio decorator on every test.
#
# WHY 'auto'? Less boilerplate - write async def test_foo() and it just works
asyncio_mode = auto

# === TEST DISCOVERY ===
# Tell pytest where to find tests and what patterns to match
#
# - python_files: Test files must start with 'test_' (e.g., test_models.py)
# - python_classes: Test classes start with 'Test' (e.g., class TestOrganism)
# - python_functions: Test functions start with 'test_' (e.g., def test_create_organism)
#
# This follows pytest's default conventions
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Tests live in the 'tests/' directory
testpaths = tests

# === TEST MARKERS ===
# Markers let you categorize and selectively run tests:
# - pytest -m unit      → Run only unit tests (fast, mocked dependencies)
# - pytest -m integration   → Run integration tests (database + API)
# - pytest -m slow      → Run slow tests (real KEGG API calls)
# - pytest -m e2e       → Run end-to-end tests (full stack)
#
# BIOINFORMATICS NOTE: Real KEGG API tests are slow (~15 min for E. coli)
# We mark them 'slow' so they don't block regular development
markers =
    unit: Unit tests (fast, mocked dependencies)
    integration: Integration tests (database + API)
    slow: Slow tests (real KEGG API calls, >10 seconds)
    e2e: End-to-end tests (full application stack)

# === OUTPUT FORMATTING ===
# Make test output more readable
#
# -v: Verbose mode - show each test name as it runs
# --tb=short: Shorter tracebacks on failures (easier to read)
# --strict-markers: Error if test uses undefined marker (catches typos)
addopts =
    --verbose
    --tb=short
    --strict-markers
    --color=yes

# === COVERAGE SETTINGS ===
# When running with --cov flag, these settings apply
#
# Example: pytest --cov=app --cov-report=html
# This generates an HTML coverage report in htmlcov/index.html
#
# --cov-report=term: Show coverage summary in terminal
# --cov-report=html: Generate browsable HTML coverage report
# --cov-fail-under=80: Fail if coverage drops below 80%
#
# WHY 80%? Industry standard for good test coverage
# Core logic (KEGG client, ortholog service, background jobs) should be 90%+
# Less critical code (schemas, simple CRUD) can be lower
[coverage:run]
source = app
omit =
    */tests/*
    */migrations/*
    */__pycache__/*
    */venv/*

[coverage:report]
precision = 2
show_missing = True
skip_covered = False

[coverage:html]
directory = htmlcov

# === LOG LEVEL ===
# Control log output during tests
# - DEBUG: See everything (useful for debugging failing tests)
# - INFO: Normal logging (default)
# - WARNING: Only warnings and errors
#
# During normal test runs, we want INFO level
# For debugging specific failures, run: pytest --log-cli-level=DEBUG
log_cli = True
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# === WARNINGS ===
# Python and libraries emit various warnings
# We want to see them during tests to catch deprecations early
filterwarnings =
    error::DeprecationWarning
    error::PendingDeprecationWarning
    # Ignore specific warnings from dependencies if needed
    # ignore::DeprecationWarning:sqlalchemy.*

# === PERFORMANCE ===
# Run tests in parallel for speed (requires pytest-xdist)
# Uncomment if you install pytest-xdist:
# addopts = -n auto

# === EXAMPLE TEST COMMANDS ===
#
# Run all tests:
#   pytest
#
# Run specific test file:
#   pytest tests/test_services/test_kegg_api_client.py
#
# Run specific test function:
#   pytest tests/test_services/test_kegg_api_client.py::test_rate_limiting
#
# Run only unit tests (fast):
#   pytest -m unit
#
# Run with coverage report:
#   pytest --cov=app --cov-report=html
#   open htmlcov/index.html
#
# Run in verbose mode with full tracebacks:
#   pytest -vv --tb=long
#
# Run and stop at first failure (useful for debugging):
#   pytest -x
#
# Run failed tests from last run:
#   pytest --lf
#
# =============================================================================
